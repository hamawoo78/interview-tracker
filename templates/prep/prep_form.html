{% extends 'base.html' %}

{% block title %}Interview Prep - {{ company.name }} - InterviewTracker{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px;">
    Interview Preparation
    <small style="color: #7f8c8d;">for {{ company.name }}</small>
</h2>

<!-- Job Summary Box (shown after AI rating) -->
<div id="jobSummaryBox" class="mb-4" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label class="form-label">Job Summary</label>
        <span id="rating-job_summary" class="badge bg-secondary" style="display: none;"></span>
    </div>
    <div class="alert alert-info" style="margin-top: 8px; margin-bottom: 0;">
        <p id="jobSummaryText" style="margin: 0;"></p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label for="{{ form.self_intro.id_for_label }}" class="form-label">Self-Introduction</label>
                            <span id="rating-self_intro" class="badge bg-secondary" style="display: none;"></span>
                        </div>
                        <small class="form-text text-muted d-block mb-2">How would you introduce yourself to the interviewer?</small>
                        {{ form.self_intro }}
                        {% if form.self_intro.errors %}
                            <div class="invalid-feedback d-block">{{ form.self_intro.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label for="{{ form.why_apply.id_for_label }}" class="form-label">Why I Applied</label>
                            <span id="rating-why_apply" class="badge bg-secondary" style="display: none;"></span>
                        </div>
                        <small class="form-text text-muted d-block mb-2">Why are you interested in this position and company?</small>
                        {{ form.why_apply }}
                        {% if form.why_apply.errors %}
                            <div class="invalid-feedback d-block">{{ form.why_apply.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label for="{{ form.questions_to_ask.id_for_label }}" class="form-label">Questions to Ask</label>
                            <span id="rating-questions_to_ask" class="badge bg-secondary" style="display: none;"></span>
                        </div>
                        <small class="form-text text-muted d-block mb-2">What questions do you want to ask the interviewer?</small>
                        {{ form.questions_to_ask }}
                        {% if form.questions_to_ask.errors %}
                            <div class="invalid-feedback d-block">{{ form.questions_to_ask.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label for="{{ form.additional_notes.id_for_label }}" class="form-label">Additional Notes</label>
                            <span id="rating-additional_notes" class="badge bg-secondary" style="display: none;"></span>
                        </div>
                        <small class="form-text text-muted d-block mb-2">Any other notes or preparation details</small>
                        {{ form.additional_notes }}
                        {% if form.additional_notes.errors %}
                            <div class="invalid-feedback d-block">{{ form.additional_notes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Prep Notes</button>
                        <button type="button" class="btn btn-outline-info" id="rateBtn">
                            <span id="rateBtnText"><i class="bi bi-stars"></i> Get AI Rating</span>
                            <span id="rateBtnSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>
                        <a href="{% url 'company_detail' company.pk %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
// Handle AI rating
document.getElementById('rateBtn').addEventListener('click', async function() {
    const rateBtn = document.getElementById('rateBtn');
    const rateBtnText = document.getElementById('rateBtnText');
    const rateBtnSpinner = document.getElementById('rateBtnSpinner');
    
    // Get form values
    const prepAnswers = {
        self_intro: document.getElementById('id_self_intro').value,
        why_apply: document.getElementById('id_why_apply').value,
        questions_to_ask: document.getElementById('id_questions_to_ask').value,
        additional_notes: document.getElementById('id_additional_notes').value,
    };
    
    // Show loading state
    rateBtn.disabled = true;
    rateBtnText.style.display = 'none';
    rateBtnSpinner.style.display = 'inline-block';
    
    try {
        // Call API endpoint
        const response = await fetch('{% url "rate_prep_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                company_id: '{{ company.pk }}',
                prep_answers: prepAnswers
            })
        });
        
        const result = await response.json();
        
        if (result.ok) {
            // Display ratings
            displayRatings(result.ratings);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // Reset button state
        rateBtn.disabled = false;
        rateBtnText.style.display = 'inline';
        rateBtnSpinner.style.display = 'none';
    }
});

// Display ratings next to field titles
function displayRatings(ratings) {
    const fields = ['self_intro', 'why_apply',  'additional_notes'];
    // 'questions_to_ask',
    
    // Display job summary if available
    if (ratings.job_summary) {
        console.log(ratings.job_summary)
        document.getElementById('jobSummaryText').textContent = ratings.job_summary;
        document.getElementById('jobSummaryBox').style.display = 'block';
    }
    
    fields.forEach(field => {
        if (ratings[field]) {
            const score = ratings[field].score;
            const badge = document.getElementById('rating-' + field);
            
            // Determine color based on score
            let badgeClass = 'bg-danger'; // 1-3
            if (score >= 4 && score <= 7) badgeClass = 'bg-warning';
            if (score >= 8) badgeClass = 'bg-success';
            
            // Set badge content and show it
            badge.className = 'badge ' + badgeClass;
            badge.textContent = score + '/10';
            badge.style.display = 'inline-block';
            badge.title = ratings[field].feedback;
        }
    });
}
</script>
{% endblock %}
